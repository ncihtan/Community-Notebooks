---
title: "Evalute available HTAN Data for an Analysis Project "
author: "Vesteinn Þórsson, David Gibbs, ISB and Adam Taylor, Sage Bionetworks"
date: "Edited January, 2025"
output:
  html_document:
    keep_md: true
    highlight: tango
    toc: true
    toc_float:
      collapsed: TRUE
      smooth_scroll: false
---
```{r global options, echo = FALSE}
#List other global opts here if relevant
knitr::opts_chunk$set(fig.align="center") #Figures should be centered
## Utility to parse participant ID from other HTAN ID
participant_from_other_htan_id<- function(a){str_c(str_split(a,"_")[[1]][1:2],collapse="_")}
```

# 1. Introduction & Overview 

[HTAN](https://humantumoratlas.org/) is a National Cancer Institute (NCI)-funded Cancer Moonshot$^{SM}$ initiative to construct 3-dimensional atlases of the dynamic cellular, morphological, and molecular features of human cancers as they evolve from precancerous lesions to advanced disease ( [Cell April 2020](https://www.sciencedirect.com/science/article/pii/S0092867420303469) ).

Clinical data, sample biospecimen data and assay files in HTAN have a rich set of annotations supplied by HTAN data contributors.  These annotations are made according to the [HTAN Data model](https://data.humantumoratlas.org/standards), a set of standards defined by the HTAN consortium. The supplied values of these attributes have been collected into comprehensive data tables on the cloud, using the Google BigQuery structure that is part of Google Cloud Project.

### 1.1 Goal

This example notebook illustrates how to make use of HTAN Google BigQuery metadata tables to tabulate and plot available HTAN clinical, biospecimen, and assay metadata describing files available from [HTAN](https://data.humantumoratlas.org/). Summaries for other available metadata attributes can be generated by extending these examples.

### 1.2 Inputs, Outputs, & Data

The originating data can be found on the [HTAN Data Portal](https://data.humantumoratlas.org/), and the compiled tables are on the [Cancer Gateway in the Cloud](https://isb-cgc.appspot.com/).

### 1.3 Notes

The queries and results in this notebook correspond to HTAN Data Release 6. To choose a different release, edit the BigQuery table names in this notebook by replacing the string `r6` with a selected numbered release, e.g. `r2`. To get results for the most current data release, replace `r6` with `current` and `HTAN_versioned` with `HTAN`.  (For example replace `isb-cgc-bq.HTAN_versioned.clinical_tier1_demographics_r6` with `isb-cgc-bq.HTAN.clinical_tier1_demographics_current`).

# 2. Environment & Library Setup
```{r}
suppressMessages(library(tidyverse))
suppressMessages(library(bigrquery))
suppressMessages(library(knitr))
suppressMessages(library(reshape2))
suppressMessages(library(kableExtra))
```

# 3. Google Authentication

Running the BigQuery cells in this notebook requires a Google Cloud Project. Instructions for creating a project can be
found in [Google cloud documentation](https://cloud.google.com/resource-manager/docs/creating-managing-projects#console).
The instance needs to be authorized to bill the project for queries. For more information on getting started see
[Quick Start Guide to ISB-CGC](https://isb-cancer-genomics-cloud.readthedocs.io/en/latest/sections/HowToGetStartedonISB-CGC.html).
Alternative authentication methods can be found in the [Google Documentation](https://cloud.google.com/resource-manager/docs/creating-managing-projects#console).

```{r}

billing <- 'htan-dcc' # Insert your project ID in the ''
if (billing == 'your_project_id') {
  print('Please update the project id with your Google Cloud Project')
}
```


# 4. Analyzing Clinical Data in HTAN

In the [HTAN Data model](https://data.humantumoratlas.org/standards), [Tier 1 Clinical Data](https://data.humantumoratlas.org/standard/clinical) has seven components: Demographics, Diagnosis, Exposure, Family History, Follow Up, Molecular Test, and Therapy. All HTAN demographic data is collected into a single Demographics table (*isb-cgc-bq.HTAN_versioned.clinical_tier1_demographics_r6*) in Google BigQuery containing data across all [HTAN Centers](https://humantumoratlas.org/research-network). The same is true of Diagnosis, and so on.

### 4.1 Treatment 

Let's take a look at annotated treatment in HTAN. This can be found in the Therapy table.

```{r cache=TRUE}
sql  <- "select * from `isb-cgc-bq.HTAN_versioned.clinical_tier1_therapy_r6`"
tb <- bq_project_query(billing, sql)
therapy <- bq_table_download(tb)
therapy <- therapy %>% select(-entityId,-Component, -Manifest_Id, -Manifest_Version, -Id) %>% distinct()
therapy$HTAN_Center <- gsub("HTAN ","",therapy$HTAN_Center)
```

Now filter this table to retrieve instances of annotated therapy. 

```{r}
therapy_yes <- therapy %>%
    filter((Treatment_or_Therapy == "Yes" | !is.na(.$Treatment_Type) )
& !Treatment_Type %in% c("Not Reported","None","unknown","Not Reported,"))
```

These are `r nrow(therapy_yes)` in number, for `r length(unique(therapy_yes$HTAN_Participant_ID))` participants.


By center and treatment type:
```{r}
therapy_yes %>%
  group_by(HTAN_Center,Treatment_Type) %>%
  tally() %>% arrange(desc(n)) %>%
  kable() %>%  scroll_box(width = "800px", height = "300px")

```
Participants with multiple entries for therapy 

```{r}
sql  <- "SELECT * FROM (
  SELECT *, COUNT(1) OVER(PARTITION BY HTAN_Participant_ID) multiple_entries
  FROM `htan-dcc.combined_assays.Therapy`
)
WHERE multiple_entries > 1"
tb <- bq_project_query(billing, sql)
multi_therapy_table <- bq_table_download(tb)
kable(multi_therapy_table) %>% 
  scroll_box(width = "800px", height = "300px")
```


# 6. Assay types in HTAN 

HTAN data is generated from multiple assay types, probing cancers and the tumor microenvironment at molecular, cellular, and tissue level,
using bulk, single-cell, and spatial assays. As described on the [HTAN Data Standards](https://data.humantumoratlas.org/standards)
page, generated data are arranged into data "Levels" corresponding to bioinformatic processing steps. In BigQuery, each
assay type and level is collected into a single table. 

For example, we can take a look at Single Cell RNA-seq Level 4 metadata by querying the table `isb-cgc-bq.HTAN_versioned.scRNAseq_level4_metadata_r6`

```{r, cache=TRUE, echo=T}
sql <- "SELECT * FROM `isb-cgc-bq.HTAN_versioned.scRNAseq_level4_metadata_r6`"
tb <- bq_project_query(billing, sql)
scl4 <- bq_table_download(tb)
scl4 %>% head(10) %>% kable() 
```

The [HTAN ID Provenance](https://isb-cgc.appspot.com/bq_meta_search/isb-cgc-bq.HTAN.id_provenance_current/) table pulls a selection of attributes from each individual assay metadata table, combining all of them into a single queryable table. For an in-depth introduction to this table, please see our notebook: [HTAN_ID_Provenance_In_BQ.ipynb](https://github.com/isb-cgc/Community-Notebooks/blob/master/HTAN/Python%20Notebooks/HTAN_ID_Provenance_In_BQ.ipynb).

Using the provenance table, we can tally the number of files available for each assay and level.

```{r, cache=TRUE, echo=T}
sql <- "SELECT Component, HTAN_Center, Count(*) AS Count
  FROM `isb-cgc-bq.HTAN_versioned.id_provenance_r6`
  WHERE Component LIKE '%Level%'
  GROUP BY Component, HTAN_Center
  ORDER BY Component, HTAN_Center"
tb <- bq_project_query(billing, sql)
all_files <- bq_table_download(tb)
```
```{r}
all_files_pivot <- dcast(all_files, Component ~ HTAN_Center, value.var = "Count", fun.aggregate = sum, fill = 0)
all_files_pivot %>% kable()
```


# 7. Relevant Citations and Links 

[Cell April 2020](https://www.sciencedirect.com/science/article/pii/S0092867420303469)


